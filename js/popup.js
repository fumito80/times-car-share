(function(){var $;$=jQuery;$(function(){var FavoriteTabView,MainView,OptionsMiscModel,PlainModel,SearchTabView,StationCollection,StationModel,mainView,tp;PlainModel=Backbone.Model.extend({});StationModel=Backbone.Model.extend({idAttribute:"scd"});StationCollection=Backbone.Collection.extend({model:StationModel,comparator:function(model){return model.get("ordernum")}});OptionsMiscModel=Backbone.Model.extend({defaults:{tabid:0,centerAddress:"",centerAddressFav:"",selectRangeFrom:0,selectRangeTo:3,selectListOrder:"WALKING",selectListMax:"5",checkMap:true,dispMax:15,mapRouteRetryTimes:4,mapRouteWaitMSec:2e3}});SearchTabView=Backbone.View.extend({SelectMaxListView:Backbone.View.extend({el:"#selectListMax",events:{change:"onChange"},initialize:function(options){var i,k;for(i=k=1;k<=7;i=++k){this.$el.append($("<option />",{value:i,text:i}))}this.$el.val(this.model.get("selectListMax"));return this.model.on("change:selectListMax",this.onChangeSelectListMax,this)},onChange:function(){return this.model.set({selectListMax:this.$el.val()})},onChangeSelectListMax:function(){return this.$el.val(this.model.get("selectListMax"))}}),SelectSearchOrder:Backbone.View.extend({el:"#selectListOrder",events:{change:"onChange"},initialize:function(){this.$el.val(this.model.get("selectListOrder"));return this.model.on("change:selectListOrder",this.onChangeSelectSearchOrder,this)},onChange:function(){return this.model.set({selectListOrder:this.$el.val()})},onChangeSelectSearchOrder:function(){return this.$el.val(this.model.get("selectListOrder"))}}),initialize:function(){new this.SelectMaxListView({model:this.model});return new this.SelectSearchOrder({model:this.model})}});FavoriteTabView=Backbone.View.extend({StationView:Backbone.View.extend({el:"<tr/>",initialize:function(){return this.model.on("change:checked",this.renderOnChecked,this)},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},renderOnChecked:function(){if(this.model.get("checked")){return this.$("i.icon-ok").addClass("checked")}else{return this.$("i.icon-ok").removeClass("checked")}},template:_.template('<td>\n  <i class="icon-ok<% if (checked) { %> checked<% } %>"></i>\n  <div class="station" title="<%= place %>"><%= alias %></div>\n  <input type="hidden" value="<%= scd %>">\n</td>')}),StationsView:Backbone.View.extend({el:"#listitem",events:{"click td":"onClick"},initialize:function(){this.collection.on("add",this.render,this);return this.$el.sortable({delay:150,disabled:false,handle:"div,label,td",cursor:"pointer",helper:"clone",scroll:false,start:function(_this){return function(event,ui){_this.$("tr.ui-sortable-placeholder").append('<td><div class="ui-icon ui-icon-triangle-1-e"></div></td>');return _this.$("label").css("cursor","pointer")}}(this),stop:function(_this){return function(event,ui){_this.$("label").css("cursor","default");_this.$("tr").each(function(i,elem){var scd;scd=$(elem).find("input").val();return _this.collection.get(scd).set({ordernum:i})});return _this.collection.sort()}}(this),update:function(_this){return function(event,ui){return _this.$el}}(this)})},render:function(model){return this.$el.append(new this.options.StationView({model:model}).render().$el)},checkAll:function(checked){return this.collection.each(function(_this){return function(model){return model.set({checked:checked})}}(this))},onClick:function(event){var checked,model,parent$,scd,target;scd=(parent$=$(event.currentTarget)).find("input").val();if(model=this.collection.get(scd)){target=parent$.find("i.icon-ok");if(target.hasClass("checked")){target.removeClass("checked");checked=false}else{checked=true;target.addClass("checked")}return model.set({checked:checked},{silent:true})}},switchModeEdit:function(){var enable,width;enable=!(this.$("input:text").length>0);if(enable){width=this.$("td:first").width();this.$("td").each(function(){var forid,label,text,title;label=$(this).css("padding","0.2em 0.3em").find("div.station");text=label.text();title=label.attr("title");forid=$(this).find("input").val();return label.replaceWith($("<input />",{type:"text",value:text,title:title,id:"chk"+forid}).width(width).css("border","1px solid #9999FF"))});$("doit").attr("disabled","disabled");return this.$("i.icon-ok,fieldset,div.iconbutton").hide()}else{this.$("td").each(function(){var alias,alias$;alias$=$(this).css("padding","").css("padding-right","2em").find("input:text");if($.trim(alias$.val())===""){alias=alias$.attr("title")}else{alias=alias$.val()}return alias$.replaceWith($("<div />",{class:"station",title:alias$.attr("title"),text:alias}))});$("doit").removeAttr("disabled");this.$("i.icon-ok,fieldset,div.iconbutton").show();return $.each(this.collection.models,function(_this){return function(i,model){return model.set({alias:_this.$("td").find("input[value='"+model.id+"']").parent().find("div.station").text()})}}(this))}}}),AllChkButtonView:Backbone.View.extend({el:"div.iconbutton",events:{click:"onClick"},onClick:function(){this.$el.toggleClass("checked");return this.trigger("checkAll",this.$el.hasClass("checked"))}}),SettingButtonView:Backbone.View.extend({el:"i.icon-edit",events:{click:"renderOnClick"},renderOnClick:function(){this.trigger("switchModeEdit");return false}}),initialize:function(){var allChkButtonView,settingButtonView;this.stationsView=new this.StationsView({collection:new StationCollection,StationView:this.StationView});allChkButtonView=new this.AllChkButtonView;settingButtonView=new this.SettingButtonView;allChkButtonView.on("checkAll",this.stationsView.checkAll,this.stationsView);return settingButtonView.on("switchModeEdit",this.stationsView.switchModeEdit,this.stationsView)}});MainView=Backbone.View.extend({el:"body",events:{click:"onClick"},onClick:function(){return this.$("#divPanel").hide()},TabView:Backbone.View.extend({initialize:function(){return this.model.on("change:tabid",this.onChangeTabid,this)},events:{click:"renderOnClick"},renderOnClick:function(){return this.model.set({tabid:this.options.index})},onChangeTabid:function(){if(this.model.get("tabid")===this.options.index){return this.setCurrentTab()}},setCurrentTab:function(){this.trigger("reset");$("div.tabPanel").eq(this.options.index).show();return this.$el.addClass("current")}}),TabsView:Backbone.View.extend({el:"ul.tabs li",initialize:function(){var inputCenterAddress,inputCenterAddressFav;inputCenterAddress=new this.options.InputCenterAddress({model:this.model});inputCenterAddressFav=new this.options.InputCenterAddressFav({model:this.model});this.$el.each(function(_this){return function(i,el){return new _this.options.TabView({model:_this.model,el:el,index:i,inputCenterAddress:inputCenterAddress}).on("reset",_this.reset,_this)}}(this));return this.model.trigger("change:tabid")},reset:function(){$("div.tabPanel").hide();return this.$el.removeClass("current")}}),InputCenterAddress:Backbone.View.extend({el:"#centerAddress",initialize:function(){this.$el.val(this.model.get("centerAddress")||"");this.$el.on("change",this.onChange.bind(this));return this.model.on("change:centerAddress",this.onChangeCenterAddress,this)},onChange:function(){return this.model.set({centerAddress:this.$el.val()})},onChangeCenterAddress:function(){return this.$el.val(this.model.get("centerAddress"))}}),InputCenterAddressFav:Backbone.View.extend({el:"#centerAddressFav",initialize:function(){this.$el.val(this.model.get("centerAddressFav")||"");this.$el.on("change",this.onChange.bind(this));return this.model.on("change:centerAddressFav",this.onChangeCenterAddress,this)},onChange:function(){return this.model.set({centerAddressFav:this.$el.val()})},onChangeCenterAddress:function(){return this.$el.val(this.model.get("centerAddressFav"))}}),CloseButtonView:Backbone.View.extend({el:"i.icon-remove",events:{click:"onClick"},onClick:function(){return window.close()}}),StartButtonView:Backbone.View.extend({el:"form.inputForm",events:{"click #doit":"onSubmit"},onSubmit:function(){var activity,checkedList;activity=mainView.getActivity();if(activity.misc.tabid===tp.tabidFavorite){checkedList=$.grep(activity.favs,function(elem){return elem.checked});if(checkedList.length===0){return this.showAlert("div.tabFavorite table tr:first","チェックされていません")}activity.misc.centerAddress=activity.misc.centerAddressFav}activity.misc.centerAddress=$.trim(activity.misc.centerAddress);return chrome.tabs.getSelected(null,function(tab){var uidparams;if(/newtab.html/.test(tab.url)){uidparams=/[\\?&]uid=([^&#]*)/.exec(tab.url);tp.setActivity(uidparams[1],activity);chrome.tabs.sendMessage(tab.id,"restart")}else{tp.createNewTab(activity)}return window.close()})},setEnable:function(){return this.$("#doit").removeAttr("disabled").removeClass("disabled").focus()},showAlert:function(selector,msg){mainView.alertView.setElement(selector);mainView.alertView.model.set({contents:msg});return false}}),AlertView:Backbone.View.extend({initialize:function(){$.balloon.defaults.classname="balloon";$.balloon.defaults.position="top";$.balloon.defaults.css={"font-size":"75%","white-space":"normal",minWidth:"20px",padding:"5px",borderRadius:"6px",border:"solid 1px #777",boxShadow:"4px 4px 4px #555",color:"#333",backgroundColor:"#FFC",opacity:"1",zIndex:"32767",textAlign:"left"};return this.model.on("change",this.render,this)},render:function(){this.$el.showBalloon(this.model.toJSON()).focus();setTimeout('$("'+this.$el.selector+'").hideBalloon()',2e3);return this.model.clear({silent:true})}}),getActivity:function(){var activity;activity={};activity.favs=this.favoriteTabView.stationsView.collection.toJSON();activity.misc=this.miscModel.toJSON();return activity},initialize:function(){this.miscModel=new OptionsMiscModel;new this.TabsView({model:this.miscModel,TabView:this.TabView,InputCenterAddress:this.InputCenterAddress,InputCenterAddressFav:this.InputCenterAddressFav});new SearchTabView({model:this.miscModel});this.favoriteTabView=new FavoriteTabView({model:this.miscModel});new this.CloseButtonView;this.startButtonView=new this.StartButtonView;this.alertView=new this.AlertView({model:new PlainModel});return $(window).on("unload",this.onWindowUnload.bind(this))},onWindowUnload:function(){var activity;this.favoriteTabView.stationsView.switchModeEdit(false);activity=this.getActivity();localStorage.myfavs=JSON.stringify(activity);return $.each(activity.favs,function(i,station){var savedStation;if(savedStation=tp.getLocalDB(station.scd)){savedStation.alias=station.alias;return tp.setLocalDB(station.scd,savedStation)}else{savedStation={};savedStation.alias=station.alias;savedStation.name=station.place;return tp.setLocalDB(station.scd,savedStation)}})},run:function(){var favorites,storageData;favorites=tp.getFavorites().slice(0);storageData={};if(localStorage.myfavs||(localStorage.myfavs=localStorage.myscd)){storageData=JSON.parse(localStorage.myfavs);if(storageData.scdList){storageData.favs=storageData.scdList;delete storageData.scdList}}if(storageData.favs){$.each(storageData.favs,function(_this){return function(i,station){station.place="不明";$.each(favorites,function(j,favorite){if(station.scd===favorite.scd){station.place=favorite.place;favorites.splice(j,1);return false}});if(station.place!=="不明"){return _this.favoriteTabView.stationsView.collection.push(station)}}}(this))}$.each(favorites,function(_this){return function(i,favorite){return _this.favoriteTabView.stationsView.collection.push(favorite)}}(this));this.miscModel.set(storageData.misc||{});return chrome.tabs.getSelected(null,function(_this){return function(tab){if(/newtab.html/.test(tab.url)){return chrome.tabs.sendMessage(tab.id,"requestStartTrigger",function(resp){if(resp==="ok"){return _this.startButtonView.setEnable()}})}else{return _this.startButtonView.setEnable()}}}(this))}});tp=chrome.extension.getBackgroundPage().window.tp;mainView=new MainView;mainView.run();return this})}).call(this);
(function(a){function e(a,b,c){if(c.url){b.load(c.url,function(e,f,g){if(c.ajaxComplete)c.ajaxComplete(e,f,g);d(a,b,c)})}else{var e=c.contents||a.attr("title");if(e&&e!=b.html()){b.html(e);a.removeAttr("title")}}}function d(d,e,f){function n(a,b,c,d,e){var f=Math.round(d/1.7320508);b.inactive()["setBorder"+c.camel.pos.f](d)["setBorder"+c.camel.pos.c1](f)["setBorder"+c.camel.pos.c2](f)["set"+c.camel.pos.p1](c.isTopLeft?-d:a.inner[c.size.p])["set"+c.camel.pos.c1](a.inner[c.size.c]/2-f).active().$.css("border-"+c.pos.f+"-color",e)}var g,h,i={position:"absolute",height:"0",width:"0",border:"solid 0 transparent"},j=new c(d),k=new c(e);k.setTop(-f.offsetY+(f.position&&f.position.indexOf("top")>=0?j.top-k.height:f.position&&f.position.indexOf("bottom")>=0?j.bottom:j.center.top-k.height/2));k.setLeft(f.offsetX+(f.position&&f.position.indexOf("left")>=0?j.left-k.width:f.position&&f.position.indexOf("right")>=0?j.right:j.center.left-k.width/2));if(f.tipSize>0){if(e.data("outerTip")){e.data("outerTip").remove();e.removeData("outerTip")}if(e.data("innerTip")){e.data("innerTip").remove();e.removeData("innerTip")}g=new c(a("<div>").css(i).appendTo(e));h=new c(a("<div>").css(i).appendTo(e));var l;for(var m=0;m<b.pos.length;m++){l=b.getRelativeNames(m);if(k.center[l.pos.c1]>=j[l.pos.c1]&&k.center[l.pos.c1]<=j[l.pos.c2]){if(m%2==0){if(k[l.pos.o]>=j[l.pos.o]&&k[l.pos.f]>=j[l.pos.f])break}else{if(k[l.pos.o]<=j[l.pos.o]&&k[l.pos.f]<=j[l.pos.f])break}}l=null}if(l){k["set"+l.camel.pos.p1](k[l.pos.p1]+(l.isTopLeft?1:-1)*(f.tipSize-k["border"+l.camel.pos.o]));n(k,g,l,f.tipSize,e.css("border-"+l.pos.o+"-color"));n(k,h,l,f.tipSize-2*k["border"+l.camel.pos.o],e.css("background-color"));e.data("outerTip",g.$).data("innerTip",h.$)}else{a.each([g.$,h.$],function(){this.remove()})}}}function c(){this.initialize.apply(this,arguments)}var b={};b.pos=a.extend(["top","bottom","left","right"],{camel:["Top","Bottom","Left","Right"]});b.size=a.extend(["height","width"],{camel:["Height","Width"]});b.getRelativeNames=function(a){var c={pos:{o:a,f:a%2==0?a+1:a-1,p1:a%2==0?a:a-1,p2:a%2==0?a+1:a,c1:a<2?2:0,c2:a<2?3:1},size:{p:a<2?0:1,c:a<2?1:0}};var d={};for(var e in c){if(!d[e])d[e]={};for(var f in c[e]){d[e][f]=b[e][c[e][f]];if(!d.camel)d.camel={};if(!d.camel[e])d.camel[e]={};d.camel[e][f]=b[e].camel[c[e][f]]}}d.isTopLeft=d.pos.o==d.pos.p1;return d};(function(){function f(a,c){if(c==undefined){f(a,true);return f(a,false)}var d=b.getRelativeNames(c?0:2);a[d.size.p]=a.$["outer"+d.camel.size.p]();a[d.pos.f]=a[d.pos.o]+a[d.size.p];a.center[d.pos.o]=a[d.pos.o]+a[d.size.p]/2;a.inner[d.pos.o]=a[d.pos.o]+a["border"+d.camel.pos.o];a.inner[d.size.p]=a.$["inner"+d.camel.size.p]();a.inner[d.pos.f]=a.inner[d.pos.o]+a.inner[d.size.p];a.inner.center[d.pos.o]=a.inner[d.pos.f]+a.inner[d.size.p]/2;return a}var d={setBorder:function(a,b){return function(c){this.$.css("border-"+a.toLowerCase()+"-width",c+"px");this["border"+a]=c;return this.isActive?f(this,b):this}},setPosition:function(a,b){return function(c){this.$.css(a.toLowerCase(),c+"px");this[a.toLowerCase()]=c;return this.isActive?f(this,b):this}}};c.prototype={initialize:function(c){this.$=c;a.extend(true,this,this.$.offset(),{center:{},inner:{center:{}}});for(var d=0;d<b.pos.length;d++){this["border"+b.pos.camel[d]]=parseInt(this.$.css("border-"+b.pos[d]+"-width"))||0}this.active()},active:function(){this.isActive=true;f(this);return this},inactive:function(){this.isActive=false;return this}};for(var e=0;e<b.pos.length;e++){c.prototype["setBorder"+b.pos.camel[e]]=d.setBorder(b.pos.camel[e],e<2);if(e%2==0)c.prototype["set"+b.pos.camel[e]]=d.setPosition(b.pos.camel[e],e<2)}})();a.fn.balloon=function(b){b=a.extend(true,{},a.balloon.defaults,b);return this.one("focus",function(c){var d=a(this),e=this;d.showBalloon(b).focus(function(b){var c=d.data("balloon").get(0);if(c&&(c==b.relatedTarget||a.contains(c,b.relatedTarget)))return;d.showBalloon()}).data("balloon").mouseleave(function(b){if(e==b.relatedTarget||a.contains(e,b.relatedTarget))return;d.hideBalloon()}).focus(function(a){d.showBalloon()})}).mouseleave(function(b){var c=a(this);var d=c.data("balloon").get(0);if(d==b.relatedTarget||a.contains(d,b.relatedTarget))return;c.hideBalloon()})};a.fn.showBalloon=function(b){var c,f;if(!a.balloon.defaults.css)a.balloon.defaults.css={};if(b||!this.data("options"))this.data("options",a.extend(true,{},a.balloon.defaults,b));b=this.data("options");return this.each(function(){c=a(this);if(c.data("offTimer"))clearTimeout(c.data("offTimer"));if(c.data("balloon")){f=c.data("balloon");e(c,f,b);d(c,f,b)}else{f=b.contents?a("<div>").append(b.contents):a("<div>",{html:c.attr("title")});if(!b.url&&(!f||f.html()==""))return;if(!b.contents)c.removeAttr("title");if(b.url)f.load(b.url,function(a,e,g){if(b.ajaxComplete)b.ajaxComplete(a,e,g);d(c,f,b)});f.addClass(b.classname).css(b.css).css({visibility:"hidden",position:"absolute"}).appendTo("body");c.data("balloon",f);d(c,f,b);f.hide().css("visibility","visible")}if(b.onAnimation){b.onAnimation.apply(f.stop(true,true),[b.onDuration])}else{f.show(b.onDuration,function(){if(this.style.removeAttribute){this.style.removeAttribute("filter")}})}})};a.fn.hideBalloon=function(){options=this.data("options");return this.each(function(){var b=a(this);var c=b.data("offTimer");if(c)clearTimeout(c);b.data("offTimer",setTimeout(function(){if(options.offAnimation){options.offAnimation.apply(b.data("balloon").stop(true,true),[options.offDuration])}else{b.removeData("offTimer").data("balloon").stop(true,true).hide(options.offDuration)}},options.keep))})};a.balloon={defaults:{contents:null,url:null,ajaxComplete:null,classname:null,position:"top",offsetX:0,offsetY:0,tipSize:12,keep:300,onDuration:100,onAnimation:null,offDuration:80,offAnimation:function(a){this.fadeOut(a)},css:{minWidth:"20px",padding:"5px",borderRadius:"6px",border:"solid 1px #777",boxShadow:"4px 4px 4px #555",color:"#666",backgroundColor:"#efefef",opacity:a.support.opacity?"0.85":null,zIndex:"32767",textAlign:"left"}}}})(jQuery)
